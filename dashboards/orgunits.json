{
  "colorMapping": {
    "org_unit_type_name": {
      "Facility": "#badbad"
    }
  },
  "filters": [
    {
      "id": "level_1_name",
      "label": "Country",
      "type": "select-multiple",
      "source": {
        "dataSource": "orgunits",
        "column": "level_1_name"
      }
    },
    {
      "id": "level_2_name",
      "label": "Level 2 Name",
      "type": "select-multiple",
      "source": {
        "dataSource": "orgunits",
        "column": "level_2_name"
      },
      "dependsOn": "level_1_name"
    },
    {
      "id": "level_3_name",
      "label": "Level 3 Name",
      "type": "select-multiple",
      "source": {
        "dataSource": "orgunits",
        "column": "level_3_name"
      },
      "dependsOn": "level_2_name"
    },
    {
      "id": "org_unit_type_name",
      "label": "Org Unit Type",
      "type": "select-multiple",
      "source": {
        "dataSource": "orgunits",
        "column": "org_unit_type_name"
      }
    }
  ],
  "widgets": {
    "totalOrgUnits": {
      "type": "keyNumber",
      "label": "Total Org Units",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "metrics": [
          {
            "label": "total_orgunits",
            "sqlExpression": "COUNT(*)"
          }
        ],
        "rowLimit": 1
      }
    },
    "orgUnitsByType": {
      "type": "table",
      "label": "Org Units by Type",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "groupBy": [
          "org_unit_type_name"
        ],
        "metrics": [
          {
            "label": "count_orgunits",
            "sqlExpression": "COUNT(*)"
          }
        ],
        "rowLimit": 100
      }
    },
    "orgUnitsMap2": {
      "type": "map",
      "label": "Org Units Map - facilities",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "raw",
        "latitude": "latitude",
        "longitude": "longitude",
        "adhocFilters": [
          {
            "subject": "org_unit_type_name",
            "operator": "=",
            "comparator": "Facility"
          }
        ],
        "columns": [
          {
            "column": "org_unit_simplified_geom_geojson",
            "label": "org_unit_simplified_geom_geojson"
          },
          {
            "column": "org_unit_longitude",
            "label": "longitude"
          },
          {
            "column": "org_unit_latitude",
            "label": "latitude"
          },
          {
            "column": "org_unit_name",
            "label": "org_unit_name"
          },
          {
            "column": "level_1_name",
            "label": "Pays"
          },
          {
            "column": "level_2_name",
            "label": "Région"
          },
          {
            "column": "level_3_name",
            "label": "District"
          },
          {
            "column": "level_4_name",
            "label": "Chiefdom"
          }
        ]
      }
    },
    "orgUnitsMap": {
      "type": "map",
      "label": "Org Units Map",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "raw",
        "latitude": "latitude",
        "longitude": "longitude",
        "columns": [
          {
            "column": "org_unit_simplified_geom_geojson",
            "label": "org_unit_simplified_geom_geojson"
          },
          {
            "column": "org_unit_longitude",
            "label": "longitude"
          },
          {
            "column": "org_unit_latitude",
            "label": "latitude"
          },
          {
            "column": "org_unit_name",
            "label": "org_unit_name"
          },
          {
            "column": "level_1_name",
            "label": "Pays"
          },
          {
            "column": "level_2_name",
            "label": "Région"
          },
          {
            "column": "level_3_name",
            "label": "District"
          },
          {
            "column": "level_4_name",
            "label": "Chiefdom"
          }
        ]
      }
    },
    "allOrgunitsTable": {
      "type": "table",
      "label": "All Org Units",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "raw",
        "columns": [
          {
            "column": "org_unit_name",
            "label": "Name"
          },
          {
            "column": "org_unit_level",
            "label": "Level"
          },
          {
            "column": "org_unit_type_name",
            "label": "Type"
          },
          {
            "column": "level_1_name",
            "label": "Pays"
          },
          {
            "column": "level_2_name",
            "label": "Région"
          },
          {
            "column": "level_3_name",
            "label": "District"
          },
          {
            "column": "level_4_name",
            "label": "Chiefdom"
          }
        ],
        "rowLimit": 1000000
      }
    },
    "orgUnitsWithPoints": {
      "type": "keyNumber",
      "label": "Org Units with Points",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "metrics": [
          {
            "label": "Points",
            "sqlExpression": "COUNT(*) FILTER (WHERE org_unit_longitude IS NOT NULL)"
          }
        ],
        "rowLimit": 1
      }
    },
    "orgUnitsWithGeoJson": {
      "type": "keyNumber",
      "label": "Org Units with geojson",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "metrics": [
          {
            "label": "Points",
            "sqlExpression": "COUNT(*) FILTER (WHERE org_unit_simplified_geom_geojson IS NOT NULL)"
          }
        ],
        "rowLimit": 1
      }
    },
    "orgunitByTypePerLevel2": {
      "label": "Orgunit by Type per level 2",
      "type": "bar",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "stack": "Stack",
        "x_axis": {
          "column": "level_2_name",
          "sort_series": "name",
          "sort_series_ascending": true,
          "title": {
            "label": "",
            "margin": 15
          }
        },
        "metrics": [
          {
            "aggregate": "COUNT",
            "column": {
              "column_name": "org_unit_type_name",
              "filterable": true,
              "groupby": true,
              "type": "TEXT"
            },
            "expressionType": "SIMPLE",
            "hasCustomLabel": false,
            "label": "COUNT(org_unit_type_name)",
            "sqlExpression": null
          }
        ],
        "groupBy": [
          "level_2_name",
          "org_unit_type_name"
        ],
        "rowLimit": 10000,
        "y_axis_title": "",
        "y_axis_title_margin": 15,
        "y_axis_title_position": "Left",
        "sort_series_type": "sum",
        "color_scheme": "colorsOfRainbow",
        "show_value": false,
        "only_total": true,
        "show_legend": true,
        "legendType": "scroll",
        "legendOrientation": "top",
        "x_axis_time_format": "smart_date",
        "xAxisLabelRotation": 90
      }
    },
    "orgUnitsOverTime": {
      "type": "timeseries",
      "label": "Org Unit Modifications Over Time",
      "params": {
        "dataSource": "orgunits",
        "queryMode": "aggregate",
        "x_axis": "org_unit_updated_at",
        "time_grain_sqla": "P1W",
        "metrics": [
          {
            "label": "count_orgunits",
            "sqlExpression": "COUNT(*)"
          }
        ],
        "groupBy": [
          "org_unit_type_name"
        ],
        "rowLimit": 10000
      }
    },
    "duplicateOrgUnits": {
      "type": "table",
      "label": "Duplicate Org Units",
      "params": {
        "dataSource": "orgunits",
        "customSql": [
          "WITH orgunits_with_normalized_name AS (",
          "  SELECT *,",
          "    regexp_replace(",
          "      regexp_replace(",
          "        regexp_replace(",
          "          lower(trim(strip_accents(org_unit_name))),",
          "          '[“”]', '\"'",
          "        ),",
          "        '[‘’]', ''''",
          "      ),",
          "      '\\\\s+', ' '",
          "    ) AS org_unit_normalized_name",
          "  FROM orgunits",
          "  WHERE {% all_filters %} AND org_unit_validation_status <> 'REJECTED' ",
          "),",
          "orgunit_same_name_same_parent AS (",
          "  SELECT org_unit_normalized_name, org_unit_parent_id, COUNT(*) AS dup_count",
          "  FROM orgunits_with_normalized_name",
          "  GROUP BY org_unit_normalized_name, org_unit_parent_id",
          "  HAVING COUNT(*) > 1",
          ")",
          "SELECT",
          "  d.dup_count,",
          "  'https://iaso.bluesquare.org/dashboard/orgunits/detail/orgUnitId/' || o.org_unit_id || '/' || '|Iaso' AS org_unit_url,",
          "  o.*",
          "FROM orgunits_with_normalized_name o",
          "JOIN orgunit_same_name_same_parent d",
          "  ON o.org_unit_normalized_name = d.org_unit_normalized_name",
          "  AND o.org_unit_parent_id = d.org_unit_parent_id",
          "ORDER BY o.org_unit_normalized_name, o.org_unit_parent_id;"
        ],
        "columns": [
          {
            "column": "org_unit_name",
            "label": "org_unit_name"
          },
          {
            "column": "dup_count",
            "label": "dup_count"
          },
          {
            "column": "level_1_name",
            "label": "level_1_name"
          },
          {
            "column": "level_2_name",
            "label": "level_2_name"
          },
          {
            "column": "level_3_name",
            "label": "level_3_name"
          },
          {
            "column": "level_4_name",
            "label": "level_4_name"
          },
          {
            "column": "org_unit_url",
            "label": "org_unit_url"
          }
        ]
      }
    },
    "badCoordinatesOrgUnits": {
      "type": "table",
      "label": "Org Units coordinates not belonging to the parents",
      "params": {
        "dataSource": "orgunits",
        "customSql": [
          "WITH child_orgunits AS (",
          "  SELECT * ",
          "  FROM orgunits WHERE {% all_filters %}",
          "), ",
          "data AS (",
          "  SELECT * ",
          "  FROM orgunits WHERE {% all_filters %}",
          "), ",
          "joined AS ( ",
          "  SELECT  ",
          "    child.org_unit_id, ",
          "    child.org_unit_name, ",
          "    child.org_unit_parent_id, ",
          "    child.org_unit_latitude, ",
          "    child.org_unit_longitude, ",
          "    child.level_1_name, ",
          "    child.level_2_name, ",
          "    child.level_3_name, ",
          "    child.level_4_name, ",
          "    parent.org_unit_id AS parent_id, ",
          "    parent.org_unit_name AS parent_name,",
          "    parent.org_unit_simplified_geom_geojson ",
          "  FROM child_orgunits AS child",
          "  JOIN data AS parent",
          "    ON child.org_unit_parent_id = parent.org_unit_id",
          "),",
          "top_shapes AS ( ",
          "  SELECT * ",
          "  FROM data ",
          "  WHERE org_unit_level = 3 ",
          "    AND org_unit_simplified_geom_geojson IS NOT NULL ",
          "), ",
          "results AS (",
          "SELECT ",
          "  j.org_unit_id,",
          "  j.org_unit_name,",
          "  j.parent_name,",
          "  j.org_unit_latitude,",
          "  j.org_unit_longitude,",
          "  j.parent_id,",
          "  j.level_1_name, ",
          "  j.level_2_name, ",
          "  j.level_3_name, ",
          "  j.level_4_name, ",
          "  CASE ",
          "    WHEN EXISTS ( ",
          "      SELECT 1 ",
          "      FROM top_shapes t",
          "      WHERE ST_Contains(",
          "        ST_GeomFromGeoJSON(t.org_unit_simplified_geom_geojson),",
          "        ST_Point(j.org_unit_longitude, j.org_unit_latitude)",
          "      )",
          "    ) THEN TRUE",
          "    ELSE FALSE",
          "  END AS in_top_shape,",
          "(",
          "  SELECT ",
          "    MIN(",
          "      ST_Distance_Sphere(",
          "        ST_Point(j.org_unit_longitude, j.org_unit_latitude),",
          "        ST_Centroid(ST_GeomFromGeoJSON(t.org_unit_simplified_geom_geojson))",
          "      )",
          "    ) / 1000",
          "  FROM top_shapes t",
          ") AS distance_to_nearest_topshape_km ",
          "FROM joined AS j",
          "WHERE ",
          "  j.org_unit_latitude IS NOT NULL",
          "  AND j.org_unit_longitude IS NOT NULL",
          "  AND j.org_unit_simplified_geom_geojson IS NOT NULL",
          "  AND NOT ST_Contains(",
          "    ST_GeomFromGeoJSON(j.org_unit_simplified_geom_geojson),",
          "    ST_Point(j.org_unit_longitude, j.org_unit_latitude)",
          "  )",
          ")    ",
          "select ",
          "'https://iaso.bluesquare.org/dashboard/orgunits/detail//orgUnitId/'|| org_unit_id || '/tab/map' as org_unit_url,",
          "*",
          "from results ",
          "where in_top_shape = false "
        ],
        "columns": [
          {
            "column": "level_2_name",
            "label": "level_2_name"
          },
          {
            "column": "level_3_name",
            "label": "level_3_name"
          },
          {
            "column": "level_4_name",
            "label": "level_4_name"
          },
          {
            "column": "org_unit_name",
            "label": "org_unit_name"
          },
          {
            "column": "parent_name",
            "label": "parent_name"
          },
          {
            "column": "org_unit_longitude",
            "label": "org_unit_longitude"
          },
          {
            "column": "org_unit_latitude",
            "label": "org_unit_latitude"
          },
          {
            "column": "distance_to_nearest_topshape_km",
            "label": "distance_to_nearest_topshape_km"
          },
          {
            "column": "in_top_shape",
            "label": "in_top_shape"
          },
          {
            "column": "org_unit_url",
            "label": "org_unit_url"
          }
        ]
      }
    }
  },
  "layout": [
    {
      "type": "ParquetUploadWidget",
      "className": "mb-4",
      "defaultUrl": "./orgunits.parquet"
    },
    {
      "type": "Filters",
      "className": "flex flex-wrap gap-4 mb-4"
    },
    {
      "type": "Widget",
      "widgetKey": "tabs",
      "children": [
        {
          "type": "Tab",
          "id": "general",
          "label": "General",
          "children": [
            {
              "type": "Container",
              "className": "grid grid-cols-1 lg:grid-cols-3 gap-4",
              "children": [
                {
                  "type": "Container",
                  "className": "grid grid-cols-1 w-[350px]",
                  "children": [
                    {
                      "type": "Widget",
                      "widgetKey": "totalOrgUnits",
                      "className": ""
                    },
                    {
                      "type": "Widget",
                      "widgetKey": "orgUnitsWithPoints",
                      "className": ""
                    },
                    {
                      "type": "Widget",
                      "widgetKey": "orgUnitsWithGeoJson",
                      "className": ""
                    },
                    {
                      "type": "Widget",
                      "widgetKey": "orgUnitsByType",
                      "className": ""
                    }
                  ]
                },
                {
                  "type": "ConditionalWidget",
                  "widgetKey": "orgUnitsMap",
                  "className": "col-span-2 row-span-2"
                },
                {
                  "type": "Widget",
                  "widgetKey": "orgunitByTypePerLevel2",
                  "className": ""
                }
              ]
            },
            {
              "type": "Container",
              "className": "grid grid-cols-1 lg:grid-cols-1 gap-4",
              "children": [
               
                {
                  "type": "ConditionalWidget",
                  "widgetKey": "orgUnitsMap2",
                  "className": "lg:col-span-1"
                }
              ]
            },
            {
              "type": "Widget",
              "widgetKey": "allOrgunitsTable",
              "className": "col-span-3"
            }
          ]
        },
        {
          "type": "Tab",
          "id": "quality",
          "label": "Data Quality",
          "children": [
            {
              "type": "Widget",
              "widgetKey": "tabs",
              "children": [
                {
                  "type": "Tab",
                  "id": "badcoords",
                  "label": "Bad coordinates",
                  "children": [
                    {
                      "type": "Widget",
                      "widgetKey": "badCoordinatesOrgUnits",
                      "className": "col-span-3"
                    }
                  ]
                },
                {
                  "type": "Tab",
                  "id": "duplicated_orgunits",
                  "label": "Duplicate names, same parent",
                  "children": [
                    {
                      "type": "Widget",
                      "widgetKey": "duplicateOrgUnits",
                      "className": "col-span-3"
                    }
                  ]
                }                
              ]
            }        
          ]
        }
      ]
    }
  ]
}

